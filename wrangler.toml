# Change name if you feel like it
name = "nosflare"
compatibility_date = "2025-01-04"
main = "worker.js"

# Durable Objects binding
[[durable_objects.bindings]]
name = "RELAY_WEBSOCKET"
class_name = "RelayWebSocket"

# D1 Database binding
# Important! Change name and id settings to your own
[[d1_databases]]
binding = "RELAY_DATABASE"
database_name = "nostr-relay"
database_id = "ba4f97db-cc23-4ea0-b7da-cf8ddc3d84ef"
read_replicas = ["auto"]

# R2 bucket binding for event archive
[[r2_buckets]]
binding = "EVENT_ARCHIVE"
bucket_name = "nostr-event-archive"

# Queue binding for event processing
[[queues.producers]]
binding = "EVENT_QUEUE"
queue = "event-processing-queue"

[[queues.consumers]]
queue = "event-processing-queue"
max_batch_size = 100
max_batch_timeout = 5
max_retries = 3
dead_letter_queue = "event-dlq"

# CPU limits (lower to 10 if not on paid Workers plan)
[limits]
cpu_ms = 300000

# Enable logs (off by default, but can enable)
[observability.logs]
enabled = false

# Durable Object migration with SQLite storage backend
[[migrations]]
tag = "v4"
new_sqlite_classes = ["RelayWebSocket"]

# Scheduled cron for event archiving
[triggers]
crons = ["0 0 * * *"]